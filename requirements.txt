# ==========================================
# Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø°ÙƒÙŠ (Filter State Engine)
# ==========================================

import datetime  # Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù„Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©

# 1. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø°ÙƒØ§Ø¡ (Default Values Registry)
if "filters" not in st.session_state:
    st.session_state.filters = {
        "wilaya": "Ø§Ù„ÙƒÙ„",          # Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø©
        "min_price": 0,             # Ø­Ø¯ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø¯Ù†Ù‰
        "max_price": 10000000,      # Ø­Ø¯ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø¹Ù„Ù‰ (Ù…Ø¹Ø¯Ù„)
        "search_query": "",         # Ù†Øµ Ø§Ù„Ø¨Ø­Ø«
        "sort_by": "Ø§Ù„Ø£Ø­Ø¯Ø«",        # Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        "category": "Ø§Ù„ÙƒÙ„",         # Ø§Ù„ÙØ¦Ø©
        "featured_only": False,     # Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ù…ÙŠØ² ÙÙ‚Ø·
        "verified_only": False,     # Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ÙˆØ«Ù‚ÙŠÙ† ÙÙ‚Ø·
        "with_images": False,       # Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø¨Ù‡Ø§ ØµÙˆØ± ÙÙ‚Ø·
        "date_range": "Ø§Ù„ÙƒÙ„",       # Ù†Ø·Ø§Ù‚ Ø²Ù…Ù†ÙŠ: Ø§Ù„ÙŠÙˆÙ…ØŒ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŒ Ø§Ù„Ø´Ù‡Ø±ØŒ Ø§Ù„ÙƒÙ„
        "price_range": [0, 10000000] # Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
    }

# 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… Ø¯ÙˆÙ† Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ (Smart Update)
def update_filters(**kwargs):
    """
    ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„Ø§ØªØ± Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£Ø®Ø±Ù‰
    Ù…Ø«Ø§Ù„: update_filters(wilaya="16", min_price=10000)
    """
    st.session_state.filters.update(kwargs)
    st.session_state.filters["last_updated"] = datetime.datetime.now().strftime("%H:%M:%S")

# Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ„Ø§ÙŠØ© Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±
update_filters(wilaya="16")

# 3. Ø£Ø¯Ø§Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ÙÙ„Ø§ØªØ± (Reset Tool)
def reset_filters():
    """Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©"""
    st.session_state.filters.update({
        "wilaya": "Ø§Ù„ÙƒÙ„",
        "min_price": 0,
        "max_price": 10000000,
        "search_query": "",
        "sort_by": "Ø§Ù„Ø£Ø­Ø¯Ø«",
        "category": "Ø§Ù„ÙƒÙ„",
        "featured_only": False,
        "verified_only": False,
        "with_images": False,
        "date_range": "Ø§Ù„ÙƒÙ„",
        "price_range": [0, 10000000]
    })
    st.session_state.filters["last_reset"] = datetime.datetime.now().strftime("%H:%M:%S")
    st.rerun()

# 4. Ø¯Ø§Ù„Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… (Query Builder)
def apply_filters_to_query(base_query, params=None):
    """
    Ø¨Ù†Ø§Ø¡ Ø§Ø³ØªØ¹Ù„Ø§Ù… SQL Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    """
    filters = st.session_state.filters
    if params is None:
        params = []
    
    conditions = ["a.status='active'"]
    
    # ÙÙ„ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ©
    if filters["wilaya"] != "Ø§Ù„ÙƒÙ„":
        conditions.append("a.wilaya LIKE ?")
        params.append(f"%{filters['wilaya']}%")
    
    # ÙÙ„ØªØ± Ø§Ù„ÙØ¦Ø©
    if filters["category"] != "Ø§Ù„ÙƒÙ„":
        conditions.append("a.category = ?")
        params.append(filters["category"])
    
    # ÙÙ„ØªØ± Ø§Ù„Ø³Ø¹Ø± (Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)
    conditions.append("a.price BETWEEN ? AND ?")
    params.append(filters["min_price"])
    params.append(filters["max_price"])
    
    # ÙÙ„ØªØ± Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
    if filters["price_range"][0] > 0 or filters["price_range"][1] < 10000000:
        conditions.append("a.price BETWEEN ? AND ?")
        params.extend(filters["price_range"])
    
    # ÙÙ„ØªØ± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø© ÙÙ‚Ø·
    if filters["featured_only"]:
        conditions.append("a.featured = 1")
    
    # ÙÙ„ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ÙˆØ«Ù‚ÙŠÙ†
    if filters["verified_only"]:
        conditions.append("EXISTS (SELECT 1 FROM users u WHERE u.username = a.owner AND u.verified = 1)")
    
    # ÙÙ„ØªØ± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙˆØ±
    if filters["with_images"]:
        conditions.append("a.images IS NOT NULL AND a.images != ''")
    
    # ÙÙ„ØªØ± Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ
    if filters["date_range"] != "Ø§Ù„ÙƒÙ„":
        if filters["date_range"] == "Ø§Ù„ÙŠÙˆÙ…":
            conditions.append("date(a.date) = date('now')")
        elif filters["date_range"] == "Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹":
            conditions.append("a.date > datetime('now', '-7 days')")
        elif filters["date_range"] == "Ø§Ù„Ø´Ù‡Ø±":
            conditions.append("a.date > datetime('now', '-30 days')")
    
    # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    where_clause = " AND ".join(conditions)
    final_query = base_query + " WHERE " + where_clause
    
    return final_query, params

# 5. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ (Smart Search)
def smart_search(df, search_text):
    """
    Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù… ÙÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
    """
    if not search_text:
        return df
    
    search_text = search_text.lower()
    
    # Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¹Ø¯Ø© Ø£Ø¹Ù…Ø¯Ø©
    mask = (
        df["product"].str.contains(search_text, case=False, na=False) |
        df["description"].str.contains(search_text, case=False, na=False) |
        df["owner"].str.contains(search_text, case=False, na=False) |
        df["phone"].str.contains(search_text, case=False, na=False)
    )
    
    return df[mask]

# 6. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø°ÙƒÙŠ (Smart Sorting)
def apply_smart_sorting(df, sort_by):
    """
    ØªØ·Ø¨ÙŠÙ‚ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    """
    if sort_by == "Ø§Ù„Ø£Ø­Ø¯Ø«":
        return df.sort_values("date", ascending=False)
    elif sort_by == "Ø§Ù„Ø£Ù‚Ø¯Ù…":
        return df.sort_values("date", ascending=True)
    elif sort_by == "Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±Ø§Ù‹":
        return df.sort_values("price", ascending=False)
    elif sort_by == "Ø§Ù„Ø£Ù‚Ù„ Ø³Ø¹Ø±Ø§Ù‹":
        return df.sort_values("price", ascending=True)
    elif sort_by == "Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø´Ø§Ù‡Ø¯Ø©":
        return df.sort_values("views", ascending=False)
    elif sort_by == "Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹":
        return df.sort_values("avg_r", ascending=False)
    elif sort_by == "Ø§Ù„Ø£ÙƒØ«Ø± ØªÙØ¶ÙŠÙ„Ø§Ù‹":
        return df.sort_values("fav_count", ascending=False)
    else:
        # Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„Ù…Ù…ÙŠØ² Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ø£Ø­Ø¯Ø«
        return df.sort_values(["featured", "date"], ascending=[False, False])

# 7. Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ÙØ¶Ù„Ø© (Save Favorite Filters)
def save_filter_preset(name):
    """
    Ø­ÙØ¸ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙƒÙ‚Ø§Ù„Ø¨
    """
    if "saved_filters" not in st.session_state:
        st.session_state.saved_filters = {}
    
    st.session_state.saved_filters[name] = st.session_state.filters.copy()
    st.session_state.saved_filters[name]["saved_at"] = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")

# 8. Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ ÙÙ„Ø§ØªØ± (Load Filter Preset)
def load_filter_preset(name):
    """
    ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ ÙÙ„Ø§ØªØ± Ù…Ø­ÙÙˆØ¸
    """
    if name in st.session_state.get("saved_filters", {}):
        st.session_state.filters.update(st.session_state.saved_filters[name])
        st.session_state.filters["loaded_from"] = name
        st.session_state.filters["loaded_at"] = datetime.datetime.now().strftime("%H:%M:%S")
        return True
    return False

# 9. Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙÙ„Ø§ØªØ± ÙÙŠ Ø§Ù„ØµÙØ­Ø© (Filter UI)
def render_filters_ui():
    """
    Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©
    """
    with st.expander("ğŸ” Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…", expanded=False):
        col1, col2, col3 = st.columns(3)
        
        with col1:
            # ÙÙ„ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ©
            wilaya_options = ["Ø§Ù„ÙƒÙ„"] + [f"{i:02d}" for i in range(1, 59)]
            selected_wilaya = st.selectbox(
                "ğŸ“ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©",
                wilaya_options,
                index=wilaya_options.index(st.session_state.filters.get("wilaya", "Ø§Ù„ÙƒÙ„"))
            )
            
            # ÙÙ„ØªØ± Ø§Ù„ÙØ¦Ø©
            category_options = ["Ø§Ù„ÙƒÙ„", "Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª", "Ø¹Ù‚Ø§Ø±Ø§Øª", "Ø³ÙŠØ§Ø±Ø§Øª", "Ø®Ø¯Ù…Ø§Øª", "Ø£Ø®Ø±Ù‰"]
            selected_category = st.selectbox(
                "ğŸ·ï¸ Ø§Ù„ÙØ¦Ø©",
                category_options,
                index=category_options.index(st.session_state.filters.get("category", "Ø§Ù„ÙƒÙ„"))
            )
        
        with col2:
            # Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø±
            min_p, max_p = st.slider(
                "ğŸ’° Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± (Ø¯Ø¬)",
                min_value=0,
                max_value=10000000,
                value=st.session_state.filters.get("price_range", [0, 10000000]),
                step=10000
            )
            
            # Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
            featured_only = st.checkbox("â­ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø© ÙÙ‚Ø·", value=st.session_state.filters.get("featured_only", False))
            verified_only = st.checkbox("âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ÙˆØ«Ù‚ÙŠÙ† ÙÙ‚Ø·", value=st.session_state.filters.get("verified_only", False))
        
        with col3:
            # Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ
            date_range = st.selectbox(
                "ğŸ“… Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©",
                ["Ø§Ù„ÙƒÙ„", "Ø§Ù„ÙŠÙˆÙ…", "Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹", "Ø§Ù„Ø´Ù‡Ø±"],
                index=["Ø§Ù„ÙƒÙ„", "Ø§Ù„ÙŠÙˆÙ…", "Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹", "Ø§Ù„Ø´Ù‡Ø±"].index(st.session_state.filters.get("date_range", "Ø§Ù„ÙƒÙ„"))
            )
            
            # ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            sort_options = ["Ø§Ù„Ø£Ø­Ø¯Ø«", "Ø§Ù„Ø£Ù‚Ø¯Ù…", "Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±Ø§Ù‹", "Ø§Ù„Ø£Ù‚Ù„ Ø³Ø¹Ø±Ø§Ù‹", "Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø´Ø§Ù‡Ø¯Ø©", "Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹", "Ø§Ù„Ø£ÙƒØ«Ø± ØªÙØ¶ÙŠÙ„Ø§Ù‹"]
            selected_sort = st.selectbox(
                "ğŸ“Š ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨",
                sort_options,
                index=sort_options.index(st.session_state.filters.get("sort_by", "Ø§Ù„Ø£Ø­Ø¯Ø«"))
            )
            
            with_images = st.checkbox("ğŸ–¼ï¸ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø¨Ù‡Ø§ ØµÙˆØ± ÙÙ‚Ø·", value=st.session_state.filters.get("with_images", False))
        
        # Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ
        search_query = st.text_input("ğŸ” ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø«", value=st.session_state.filters.get("search_query", ""))
        
        # Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
        col_a, col_b, col_c = st.columns(3)
        with col_a:
            if st.button("ğŸ” ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±", use_container_width=True):
                update_filters(
                    wilaya=selected_wilaya,
                    category=selected_category,
                    price_range=[min_p, max_p],
                    min_price=min_p,
                    max_price=max_p,
                    featured_only=featured_only,
                    verified_only=verified_only,
                    date_range=date_range,
                    sort_by=selected_sort,
                    with_images=with_images,
                    search_query=search_query
                )
                st.rerun()
        
        with col_b:
            if st.button("â™»ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·", use_container_width=True):
                reset_filters()
        
        with col_c:
            if st.button("ğŸ’¾ Ø­ÙØ¸ ÙƒÙ‚Ø§Ù„Ø¨", use_container_width=True):
                preset_name = st.text_input("Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨")
                if preset_name:
                    save_filter_preset(preset_name)
                    st.success(f"ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨: {preset_name}")

# 10. Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Saved Filters)
def render_saved_filters():
    """
    Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø© Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    """
    if "saved_filters" in st.session_state and st.session_state.saved_filters:
        with st.expander("ğŸ“ Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©"):
            for name, preset in st.session_state.saved_filters.items():
                col1, col2, col3 = st.columns([3, 1, 1])
                with col1:
                    st.write(f"**{name}**")
                    if "saved_at" in preset:
                        st.caption(f"Ù…Ø­ÙÙˆØ¸: {preset['saved_at']}")
                with col2:
                    if st.button("ğŸ“‚ ØªØ­Ù…ÙŠÙ„", key=f"load_{name}"):
                        load_filter_preset(name)
                        st.rerun()
                with col3:
                    if st.button("ğŸ—‘ï¸ Ø­Ø°Ù", key=f"delete_{name}"):
                        del st.session_state.saved_filters[name]
                        st.rerun()

# ==========================================
# Ø¯Ù…Ø¬ Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„Ø§ØªØ± Ù…Ø¹ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
# ==========================================
def show_market_with_filters(conn):
    """
    Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù†Ø© Ù…Ù† show_market Ù…Ø¹ Ø¯Ø¹Ù… Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    """
    conn.execute("INSERT INTO page_views(page,view_time) VALUES('market',datetime('now'))")
    conn.commit()
    
    # Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙÙ„Ø§ØªØ±
    render_filters_ui()
    render_saved_filters()
    
    # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
    base_query = """
        SELECT a.*, IFNULL(AVG(r.rating),0) as avg_r, COUNT(r.rating) as count_r,
               (SELECT COUNT(*) FROM favorites f WHERE f.ad_id = a.id) as fav_count
        FROM ads a 
        LEFT JOIN ratings r ON a.id = r.ad_id 
    """
    
    # ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
    query, params = apply_filters_to_query(base_query)
    query += " GROUP BY a.id"
    
    # ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
    ads = conn.execute(query, params).fetchall()
    
    # ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ DataFrame
    df = pd.DataFrame(ads, columns=["id","product","price","phone","wilaya","description","date","owner","views","featured","category","images","status","avg_r","count_r","fav_count"])
    
    # ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ
    if st.session_state.filters["search_query"]:
        df = smart_search(df, st.session_state.filters["search_query"])
    
    # ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø°ÙƒÙŠ
    if len(df) > 0:
        df = apply_smart_sorting(df, st.session_state.filters["sort_by"])
        
        # Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        st.markdown(f"### ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«: {len(df)} Ø¥Ø¹Ù„Ø§Ù†")
        
        # Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ø¹ Pagination
        items_per_page = 5
        total_pages = max(1, (len(df) + items_per_page - 1) // items_per_page)
        
        if total_pages > 1:
            page = st.number_input("Ø§Ù„ØµÙØ­Ø©", min_value=1, max_value=total_pages, value=1)
            start_idx = (page - 1) * items_per_page
            end_idx = min(start_idx + items_per_page, len(df))
            current_df = df.iloc[start_idx:end_idx]
        else:
            current_df = df
        
        # Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
        for _, ad in current_df.iterrows():
            # Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ù†ÙØ³ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø§Ø¨Ù‚)
            with st.container():
                st.markdown(f"""
                    <div class="ad-card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <h2 style="margin:0; color:#006633;">{ad['product']} 
                                {f'<span class="badge-premium">â­ Ù…Ù…ÙŠØ²</span>' if ad['featured'] else ''}</h2>
                                <p>{ad['description'][:200]}...</p>
                                <p>ğŸ“ {ad['wilaya']} | ğŸ’° {ad['price']:,} Ø¯Ø¬ | ğŸ‘ï¸ {ad['views']}</p>
                                <p>â­ {ad['avg_r']:.1f} | ğŸ’– {ad['fav_count']}</p>
                            </div>
                        </div>
                    </div>
                """, unsafe_allow_html=True)
    else:
        st.info("ğŸ˜• Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«")

# ==========================================
# ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ù„Ø© dashboard Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
# ==========================================
def dashboard():
    track_visitor()
    track_session()
    conn = get_connection()
    
    with st.sidebar:
        st.markdown(f"### ğŸ–ï¸ {st.session_state.user}")
        
        # Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© Ù…Ù† Ø§Ù„ÙÙ„Ø§ØªØ±
        st.caption(f"ğŸ”„ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„ÙÙ„Ø§ØªØ±: {st.session_state.filters.get('last_updated', 'Ù„Ù… ÙŠØ­Ø¯Ø«')}")
        
        # Ø¨Ù‚ÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ…Ø§ Ù‡ÙŠ...
        unread_notif = get_unread_notif(st.session_state.user)
        unread_msgs = get_unread_messages(st.session_state.user)
        total_unread = unread_notif + unread_msgs
        notif_badge = f" ğŸ”” ({total_unread})" if total_unread > 0 else " ğŸ””"
        
        online = conn.execute("SELECT COUNT(DISTINCT ip) FROM visitors WHERE last_seen > datetime('now','-5 minutes')").fetchone()[0]
        st.info(f"ğŸŸ¢ Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ù†Ø´Ø·ÙˆÙ†: {online}")
        
        menu_options = ["ğŸ” Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø°ÙƒÙŠ", "ğŸ“¢ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†", "â­ Ø§Ù„Ù…ÙØ¶Ù„Ø©", "ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„", notif_badge, "ğŸ¤– Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ", "ğŸ“Š Analytics MAX"]
        
        if st.session_state.role == "admin":
            menu_options.append("ğŸ›¡ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©")
        
        choice = st.radio("Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©", menu_options)
        
        if st.button("ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬"):
            log_activity(st.session_state.user, "logout", "User logged out")
            st.session_state.user = None
            st.rerun()
        
        # Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ sidebar
        with st.expander("ğŸ¯ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©"):
            st.json(st.session_state.filters)

    # ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª
    if choice == "ğŸ” Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø°ÙƒÙŠ":
        show_market_with_filters(conn)  # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
    elif choice == "ğŸ“¢ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†":
        post_ad(conn)
    elif choice == "â­ Ø§Ù„Ù…ÙØ¶Ù„Ø©":
        show_favorites(conn)
    elif choice == "ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„":
        show_chat_system(conn)
    elif choice == notif_badge:
        show_notifications(st.session_state.user)
    elif choice == "ğŸ¤– Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ":
        show_ai_assistant()
    elif choice == "ğŸ“Š Analytics MAX":
        show_analytics(conn)
    elif choice == "ğŸ›¡ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©" and st.session_state.role == "admin":
        admin_panel()

