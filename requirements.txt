streamlit==1.28.0
pandas==2.0.3
numpy==1.24.3
plotly==5.17.0
scikit-learn==1.3.0
scipy==1.11.1
pillow==10.0.0
requests==2.31.0
python-dotenv==1.0.0
ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ù…ØªØ·Ù„Ø¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŒ Ø¥Ù„ÙŠÙƒ Ù†Ø³Ø®Ø© Ù…Ø¹Ø¯Ù„Ø© Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© (scikit-learn):

python
import streamlit as st
import sqlite3
import pandas as pd
import hashlib
import re
import datetime
import urllib.parse
import secrets
import os
import time
import random
import json
import plotly.express as px
import plotly.graph_objects as go
from functools import wraps
from collections import Counter

# ==========================================
# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø®Ø¨Ø© TITANIUM MAX
# ==========================================
st.set_page_config(page_title="RASSIM DZ TITANIUM ULTRA", layout="wide", page_icon="ğŸ‡©ğŸ‡¿")
DB = "rassim_titanium_max_2026.db"
OLD_DB = "rassim_titanium_pro_2026.db" 

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
AI_ENABLED = True
CHATBOT_ENABLED = True
PRICE_PREDICTION_ENABLED = True

st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
    * { font-family: 'Cairo', sans-serif; direction: rtl; }
    .stApp { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .main-header {
        background: linear-gradient(135deg, #006633 0%, #006633 48%, #d21034 50%, #ffffff 52%, #ffffff 100%);
        padding: 60px; border-radius: 40px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        border-bottom: 12px solid #d21034; margin-bottom: 40px; color: white;
        animation: glow 2s ease-in-out infinite alternate;
    }
    @keyframes glow {
        from { box-shadow: 0 25px 50px rgba(0,102,51,0.3); }
        to { box-shadow: 0 25px 70px rgba(210,16,52,0.5); }
    }
    .ad-card { 
        background: white; border-radius: 25px; padding: 35px; 
        border-right: 20px solid #006633; margin-bottom: 30px; 
        box-shadow: 0 15px 35px rgba(0,0,0,0.1); transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .ad-card:hover { transform: scale(1.02); border-right-color: #d21034; }
    .price-tag { 
        background: linear-gradient(135deg, #d21034, #ff416c); 
        color: white; padding: 12px 30px; border-radius: 18px; 
        font-weight: 900; font-size: 1.8rem; 
        box-shadow: 0 5px 15px rgba(210,16,52,0.3);
    }
    .chat-bubble { 
        padding: 10px 15px; border-radius: 15px; margin-bottom: 5px; 
        max-width: 80%; animation: popIn 0.3s ease-out;
    }
    @keyframes popIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    .chat-sent { background: #dcf8c6; align-self: flex-start; margin-right: auto; }
    .chat-received { background: #ffffff; border: 1px solid #ddd; align-self: flex-end; margin-left: auto; }
    .badge-premium {
        background: linear-gradient(135deg, #ffd700, #ffa500);
        color: white; padding: 5px 15px; border-radius: 25px;
        font-weight: bold; display: inline-block;
    }
    .ai-suggestion {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white; padding: 20px; border-radius: 20px;
        margin: 20px 0; animation: slideIn 0.5s ease-out;
    }
    @keyframes slideIn {
        from { transform: translateX(-100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    </style>
""", unsafe_allow_html=True)

# ==========================================
# 2. Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø°ÙƒÙŠ (Filter State Engine)
# ==========================================

# ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø°ÙƒØ§Ø¡
if "filters" not in st.session_state:
    st.session_state.filters = {
        "wilaya": "Ø§Ù„ÙƒÙ„",
        "min_price": 0,
        "max_price": 10000000,
        "search_query": "",
        "sort_by": "Ø§Ù„Ø£Ø­Ø¯Ø«",
        "category": "Ø§Ù„ÙƒÙ„",
        "featured_only": False,
        "verified_only": False,
        "with_images": False,
        "date_range": "Ø§Ù„ÙƒÙ„",
        "price_range": [0, 10000000]
    }

def update_filters(**kwargs):
    """ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„Ø§ØªØ± Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£Ø®Ø±Ù‰"""
    st.session_state.filters.update(kwargs)
    st.session_state.filters["last_updated"] = datetime.datetime.now().strftime("%H:%M:%S")

def reset_filters():
    """Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±"""
    st.session_state.filters.update({
        "wilaya": "Ø§Ù„ÙƒÙ„",
        "min_price": 0,
        "max_price": 10000000,
        "search_query": "",
        "sort_by": "Ø§Ù„Ø£Ø­Ø¯Ø«",
        "category": "Ø§Ù„ÙƒÙ„",
        "featured_only": False,
        "verified_only": False,
        "with_images": False,
        "date_range": "Ø§Ù„ÙƒÙ„",
        "price_range": [0, 10000000]
    })
    st.session_state.filters["last_reset"] = datetime.datetime.now().strftime("%H:%M:%S")
    st.rerun()

def render_filters_ui():
    """Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙÙ„Ø§ØªØ±"""
    with st.expander("ğŸ” Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…", expanded=False):
        col1, col2, col3 = st.columns(3)
        
        with col1:
            wilaya_options = ["Ø§Ù„ÙƒÙ„"] + [f"{i:02d}" for i in range(1, 59)]
            selected_wilaya = st.selectbox(
                "ğŸ“ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©",
                wilaya_options,
                index=wilaya_options.index(st.session_state.filters.get("wilaya", "Ø§Ù„ÙƒÙ„"))
            )
            
            category_options = ["Ø§Ù„ÙƒÙ„", "Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª", "Ø¹Ù‚Ø§Ø±Ø§Øª", "Ø³ÙŠØ§Ø±Ø§Øª", "Ø®Ø¯Ù…Ø§Øª", "Ø£Ø®Ø±Ù‰"]
            selected_category = st.selectbox(
                "ğŸ·ï¸ Ø§Ù„ÙØ¦Ø©",
                category_options,
                index=category_options.index(st.session_state.filters.get("category", "Ø§Ù„ÙƒÙ„"))
            )
        
        with col2:
            min_p, max_p = st.slider(
                "ğŸ’° Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± (Ø¯Ø¬)",
                min_value=0,
                max_value=10000000,
                value=st.session_state.filters.get("price_range", [0, 10000000]),
                step=10000
            )
            
            featured_only = st.checkbox("â­ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø© ÙÙ‚Ø·", value=st.session_state.filters.get("featured_only", False))
            verified_only = st.checkbox("âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ÙˆØ«Ù‚ÙŠÙ† ÙÙ‚Ø·", value=st.session_state.filters.get("verified_only", False))
        
        with col3:
            date_range = st.selectbox(
                "ğŸ“… Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©",
                ["Ø§Ù„ÙƒÙ„", "Ø§Ù„ÙŠÙˆÙ…", "Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹", "Ø§Ù„Ø´Ù‡Ø±"],
                index=["Ø§Ù„ÙƒÙ„", "Ø§Ù„ÙŠÙˆÙ…", "Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹", "Ø§Ù„Ø´Ù‡Ø±"].index(st.session_state.filters.get("date_range", "Ø§Ù„ÙƒÙ„"))
            )
            
            sort_options = ["Ø§Ù„Ø£Ø­Ø¯Ø«", "Ø§Ù„Ø£Ù‚Ø¯Ù…", "Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±Ø§Ù‹", "Ø§Ù„Ø£Ù‚Ù„ Ø³Ø¹Ø±Ø§Ù‹", "Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø´Ø§Ù‡Ø¯Ø©"]
            selected_sort = st.selectbox(
                "ğŸ“Š ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨",
                sort_options,
                index=sort_options.index(st.session_state.filters.get("sort_by", "Ø§Ù„Ø£Ø­Ø¯Ø«"))
            )
            
            with_images = st.checkbox("ğŸ–¼ï¸ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø¨Ù‡Ø§ ØµÙˆØ± ÙÙ‚Ø·", value=st.session_state.filters.get("with_images", False))
        
        search_query = st.text_input("ğŸ” ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø«", value=st.session_state.filters.get("search_query", ""))
        
        col_a, col_b = st.columns(2)
        with col_a:
            if st.button("ğŸ” ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±", use_container_width=True):
                update_filters(
                    wilaya=selected_wilaya,
                    category=selected_category,
                    price_range=[min_p, max_p],
                    min_price=min_p,
                    max_price=max_p,
                    featured_only=featured_only,
                    verified_only=verified_only,
                    date_range=date_range,
                    sort_by=selected_sort,
                    with_images=with_images,
                    search_query=search_query
                )
                st.rerun()
        
        with col_b:
            if st.button("â™»ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·", use_container_width=True):
                reset_filters()

# ==========================================
# 3. Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„
# ==========================================
@st.cache_resource
def get_connection():
    return sqlite3.connect(DB, check_same_thread=False)

def migrate_old_data():
    if os.path.exists(OLD_DB):
        conn = get_connection()
        try:
            conn.execute(f"ATTACH DATABASE '{OLD_DB}' AS old_db")
            conn.execute("INSERT OR IGNORE INTO users SELECT * FROM old_db.users")
            conn.execute("INSERT OR IGNORE INTO ads SELECT * FROM old_db.ads")
            conn.execute("INSERT OR IGNORE INTO visitors SELECT * FROM old_db.visitors")
            conn.commit()
            conn.execute("DETACH DATABASE old_db")
        except Exception as e:
            st.error(f"Migration Error: {e}")

def init_db():
    conn = get_connection()
    c = conn.cursor()
    c.executescript("""
        CREATE TABLE IF NOT EXISTS users(
            id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT UNIQUE, 
            password TEXT, salt TEXT, role TEXT DEFAULT 'user', 
            last_login TEXT, banned INTEGER DEFAULT 0, ad_count INTEGER DEFAULT 0,
            email TEXT, phone TEXT, verified INTEGER DEFAULT 0, premium_until TEXT);
        
        CREATE TABLE IF NOT EXISTS ads(
            id INTEGER PRIMARY KEY AUTOINCREMENT, product TEXT, price INTEGER, 
            phone TEXT, wilaya TEXT, description TEXT, date TEXT, 
            owner TEXT, views INTEGER DEFAULT 0, featured INTEGER DEFAULT 0,
            category TEXT, images TEXT, status TEXT DEFAULT 'active');
            
        CREATE TABLE IF NOT EXISTS ratings(
            id INTEGER PRIMARY KEY AUTOINCREMENT, ad_id INTEGER, rating INTEGER,
            user TEXT, comment TEXT, date TEXT);
            
        CREATE TABLE IF NOT EXISTS login_attempts(
            id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT, attempt_time TEXT);

        CREATE TABLE IF NOT EXISTS visitors(
            id INTEGER PRIMARY KEY AUTOINCREMENT, ip TEXT, visit_date TEXT, last_seen TEXT,
            country TEXT, city TEXT, device TEXT);

        CREATE TABLE IF NOT EXISTS ad_views(
            id INTEGER PRIMARY KEY AUTOINCREMENT, ad_id INTEGER, view_time TEXT,
            viewer_ip TEXT);

        CREATE TABLE IF NOT EXISTS sessions(
            id INTEGER PRIMARY KEY AUTOINCREMENT, ip TEXT, start_time TEXT, 
            last_activity TEXT, duration INTEGER DEFAULT 0);

        CREATE TABLE IF NOT EXISTS clicks(
            id INTEGER PRIMARY KEY AUTOINCREMENT, ad_id INTEGER, click_time TEXT,
            click_type TEXT);

        CREATE TABLE IF NOT EXISTS page_views(
            id INTEGER PRIMARY KEY AUTOINCREMENT, page TEXT, view_time TEXT);

        CREATE TABLE IF NOT EXISTS favorites(
            id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT, ad_id INTEGER,
            saved_date TEXT);

        CREATE TABLE IF NOT EXISTS messages(
            id INTEGER PRIMARY KEY AUTOINCREMENT, from_user TEXT, to_user TEXT,
            message TEXT, date TEXT, read INTEGER DEFAULT 0, ad_id INTEGER);

        CREATE TABLE IF NOT EXISTS notifications(
            id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT, message TEXT,
            date TEXT, read INTEGER DEFAULT 0, type TEXT);

        CREATE TABLE IF NOT EXISTS reports(
            id INTEGER PRIMARY KEY AUTOINCREMENT, ad_id INTEGER, reported_by TEXT,
            reason TEXT, date TEXT, status TEXT DEFAULT 'pending');

        CREATE TABLE IF NOT EXISTS activity_log(
            id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT, action TEXT,
            details TEXT, date TEXT, ip TEXT);

        CREATE INDEX IF NOT EXISTS idx_ads_price ON ads(price);
        CREATE INDEX IF NOT EXISTS idx_ads_owner ON ads(owner);
        CREATE INDEX IF NOT EXISTS idx_ads_category ON ads(category);
        CREATE INDEX IF NOT EXISTS idx_ads_status ON ads(status);
        CREATE INDEX IF NOT EXISTS idx_favorites_user ON favorites(username);
        CREATE INDEX IF NOT EXISTS idx_messages_users ON messages(from_user, to_user);
    """)
    conn.commit()
    migrate_old_data()

init_db()

# ==========================================
# 4. Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ§Ù„ØªØªØ¨Ø¹
# ==========================================
def track_visitor():
    conn = get_connection()
    ip = st.session_state.get("ip")
    if not ip:
        ip = secrets.token_hex(8)
        st.session_state.ip = ip
    today = str(datetime.date.today())
    existing = conn.execute("SELECT id FROM visitors WHERE ip=? AND visit_date=?", (ip, today)).fetchone()
    if not existing:
        conn.execute("INSERT INTO visitors(ip,visit_date,last_seen,country,city,device) VALUES(?,?,datetime('now'),'Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±','ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ','Ø¬Ù‡Ø§Ø²')", (ip, today))
    else:
        conn.execute("UPDATE visitors SET last_seen=datetime('now') WHERE ip=?", (ip,))
    conn.commit()

def track_session():
    conn = get_connection()
    ip = st.session_state.get("ip", "unknown")
    now = datetime.datetime.now()
    conn.execute("INSERT OR REPLACE INTO sessions(ip,start_time,last_activity) VALUES(?,?,?)", (ip, now, now))
    conn.commit()

def log_activity(username, action, details=""):
    conn = get_connection()
    conn.execute("INSERT INTO activity_log(username, action, details, date, ip) VALUES(?,?,?,datetime('now'),?)",
                 (username, action, details, st.session_state.get("ip", "unknown")))
    conn.commit()

def hash_password(password, salt):
    return hashlib.pbkdf2_hmac('sha256', password.encode(), salt.encode(), 100000).hex()

# ==========================================
# 5. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø±Ø§Ø³Ù„Ø©
# ==========================================
def create_notification(username, message, notif_type="info"):
    conn = get_connection()
    conn.execute("INSERT INTO notifications(username, message, date, type) VALUES(?,?,datetime('now'),?)", (username, message, notif_type))
    conn.commit()

def get_unread_notif(username):
    conn = get_connection()
    return conn.execute("SELECT COUNT(*) FROM notifications WHERE username=? AND read=0", (username,)).fetchone()[0]

def get_unread_messages(username):
    conn = get_connection()
    return conn.execute("SELECT COUNT(*) FROM messages WHERE to_user=? AND read=0", (username,)).fetchone()[0]

def toggle_favorite(username, ad_id):
    conn = get_connection()
    existing = conn.execute("SELECT id FROM favorites WHERE username=? AND ad_id=?", (username, ad_id)).fetchone()
    if existing:
        conn.execute("DELETE FROM favorites WHERE id=?", (existing[0],))
        conn.commit()
        return False
    else:
        conn.execute("INSERT INTO favorites(username, ad_id, saved_date) VALUES(?,?,datetime('now'))", (username, ad_id))
        conn.commit()
        return True

def report_ad(ad_id, username, reason):
    conn = get_connection()
    conn.execute("INSERT INTO reports(ad_id, reported_by, reason, date) VALUES(?,?,?,datetime('now'))", (ad_id, username, reason))
    conn.commit()
    create_notification("admin", f"ğŸš¨ Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯: Ø¥Ø¹Ù„Ø§Ù† {ad_id}", "warning")

# ==========================================
# 6. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
# ==========================================
def show_chat_system(conn):
    st.header("ğŸ’¬ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„")
    user = st.session_state.user
    
    contacts = conn.execute("""
        SELECT DISTINCT 
            CASE WHEN from_user = ? THEN to_user ELSE from_user END as contact,
            MAX(date) as last_msg,
            (SELECT COUNT(*) FROM messages WHERE to_user=? AND from_user=contact AND read=0) as unread
        FROM messages 
        WHERE from_user = ? OR to_user = ?
        GROUP BY contact
        ORDER BY last_msg DESC
    """, (user, user, user, user)).fetchall()
    
    if not contacts:
        st.info("ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.")
        return

    col1, col2 = st.columns([1, 2])
    
    with col1:
        st.subheader("ğŸ“‹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª")
        contact_list = []
        contact_ids = []
        for c in contacts:
            unread_badge = f" ğŸ”´ ({c[2]})" if c[2] > 0 else ""
            contact_list.append(f"{c[0]}{unread_badge}")
            contact_ids.append(c[0])
        
        if contact_list:
            selected_idx = st.radio("Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø©:", range(len(contact_list)), 
                                   format_func=lambda x: contact_list[x])
            selected_contact = contact_ids[selected_idx]
            
            with col2:
                st.subheader(f"ğŸ’­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ {selected_contact}")
                
                conn.execute("UPDATE messages SET read=1 WHERE from_user=? AND to_user=?", 
                           (selected_contact, user))
                conn.commit()
                
                chat_data = conn.execute("""
                    SELECT from_user, message, date 
                    FROM messages 
                    WHERE (from_user=? AND to_user=?) OR (from_user=? AND to_user=?)
                    ORDER BY date ASC
                """, (user, selected_contact, selected_contact, user)).fetchall()
                
                chat_container = st.container(height=400)
                for msg in chat_data:
                    if msg[0] == user:
                        chat_container.markdown(f'<div style="display: flex; justify-content: flex-start; margin: 10px;"><div class="chat-bubble chat-sent"><b>{msg[0]}:</b><br>{msg[1]}<br><small>{msg[2][11:16]}</small></div></div>', unsafe_allow_html=True)
                    else:
                        chat_container.markdown(f'<div style="display: flex; justify-content: flex-end; margin: 10px;"><div class="chat-bubble chat-received"><b>{msg[0]}:</b><br>{msg[1]}<br><small>{msg[2][11:16]}</small></div></div>', unsafe_allow_html=True)
                
                with st.form(f"send_msg_{selected_contact}", clear_on_submit=True):
                    new_msg = st.text_input("âœï¸ Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...")
                    sent = st.form_submit_button("ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„")
                    
                    if sent and new_msg:
                        conn.execute("INSERT INTO messages(from_user, to_user, message, date) VALUES(?,?,?,datetime('now'))", (user, selected_contact, new_msg))
                        conn.commit()
                        create_notification(selected_contact, f"ğŸ“¨ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† {user}", "message")
                        st.rerun()

# ==========================================
# 7. Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ù…Ø¨Ø³Ø·
# ==========================================
class SimpleAI:
    def predict_price(self, category, description, wilaya):
        """ØªÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø¹Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø³ÙŠØ·Ø©"""
        conn = get_connection()
        
        similar_ads = conn.execute("""
            SELECT price FROM ads 
            WHERE category=? AND wilaya=? AND status='active'
            AND price > 0 AND price < 10000000
            ORDER BY date DESC LIMIT 20
        """, (category, wilaya)).fetchall()
        
        if len(similar_ads) < 3:
            return None
        
        prices = [a[0] for a in similar_ads]
        avg_price = sum(prices) / len(prices)
        
        # ØªØ±ØªÙŠØ¨ prices ÙˆØ¥ÙŠØ¬Ø§Ø¯ Ø§Ù„ÙˆØ³ÙŠØ·
        sorted_prices = sorted(prices)
        mid = len(sorted_prices) // 2
        median_price = sorted_prices[mid] if len(sorted_prices) % 2 else (sorted_prices[mid-1] + sorted_prices[mid]) / 2
        
        return {
            'predicted': int((avg_price * 0.5 + median_price * 0.5)),
            'min': int(min(prices)),
            'max': int(max(prices)),
            'avg': int(avg_price),
            'median': int(median_price),
            'sample_size': len(prices)
        }
    
    def get_trending_categories(self):
        conn = get_connection()
        return conn.execute("""
            SELECT category, COUNT(*) as count
            FROM ads 
            WHERE date > datetime('now', '-30 days')
            AND category IS NOT NULL
            GROUP BY category
            ORDER BY count DESC
            LIMIT 5
        """).fetchall()

# ==========================================
# 8. Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ
# ==========================================
def show_ai_assistant():
    st.markdown('<div class="ai-suggestion">', unsafe_allow_html=True)
    st.header("ğŸ¤– Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ")
    
    conn = get_connection()
    ai = SimpleAI()
    
    st.subheader("ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø°ÙƒÙŠØ©")
    
    peak_hours = conn.execute("""
        SELECT strftime('%H', view_time) as hour, COUNT(*) as views
        FROM ad_views
        WHERE view_time > datetime('now', '-7 days')
        GROUP BY hour
        ORDER BY views DESC
        LIMIT 1
    """).fetchone()
    
    if peak_hours:
        st.success(f"â° Ø£ÙØ¶Ù„ ÙˆÙ‚Øª Ù„Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†Ùƒ: Ø§Ù„Ø³Ø§Ø¹Ø© {peak_hours[0]}:00")
    
    trending = ai.get_trending_categories()
    if trending:
        st.info(f"ğŸ”¥ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø±Ø§Ø¦Ø¬Ø©: {', '.join([t[0] for t in trending[:3]])}")
    
    st.markdown('</div>', unsafe_allow_html=True)

# ==========================================
# 9. ØµÙØ­Ø© Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
# ==========================================
def post_ad(conn):
    st.header("ğŸ“¢ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯")
    
    ai = SimpleAI()
    
    with st.form("new_ad"):
        col1, col2 = st.columns(2)
        with col1:
            product = st.text_input("Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬")
            category = st.selectbox("Ø§Ù„ØªØµÙ†ÙŠÙ", ["Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª", "Ø¹Ù‚Ø§Ø±Ø§Øª", "Ø³ÙŠØ§Ø±Ø§Øª", "Ø®Ø¯Ù…Ø§Øª", "Ø£Ø®Ø±Ù‰"])
        with col2:
            price = st.number_input("Ø§Ù„Ø³Ø¹Ø± (Ø¯Ø¬)", min_value=0, step=100)
            wilaya = st.selectbox("Ø§Ù„ÙˆÙ„Ø§ÙŠØ©", [f"{i:02d}" for i in range(1, 59)])
        
        phone = st.text_input("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ")
        description = st.text_area("ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬")
        
        if PRICE_PREDICTION_ENABLED and price == 0:
            prediction = ai.predict_price(category, description, wilaya)
            if prediction:
                st.markdown(f"""
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 15px; margin: 10px 0;">
                        <h4 style="color: #006633;">ğŸ”® ØªÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø¹Ø±:</h4>
                        <p>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: <b>{prediction['predicted']:,} Ø¯Ø¬</b></p>
                        <p>Ø§Ù„Ù†Ø·Ø§Ù‚: {prediction['min']:,} - {prediction['max']:,} Ø¯Ø¬</p>
                    </div>
                """, unsafe_allow_html=True)
        
        submitted = st.form_submit_button("ğŸš€ Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†")
        
        if submitted:
            if product and price > 0 and phone:
                ad_count = conn.execute("SELECT ad_count FROM users WHERE username=?", 
                                      (st.session_state.user,)).fetchone()[0]
                
                if ad_count >= 10 and st.session_state.role != "admin":
                    st.error("Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª")
                else:
                    conn.execute("""INSERT INTO ads(product, price, phone, wilaya, description, 
                                                   date, owner, category) 
                                    VALUES(?,?,?,?,?,datetime('now'),?,?)""",
                                (product, price, phone, wilaya, description, 
                                 st.session_state.user, category))
                    conn.execute("UPDATE users SET ad_count = ad_count + 1 WHERE username=?", 
                               (st.session_state.user,))
                    conn.commit()
                    log_activity(st.session_state.user, "post_ad", f"Posted: {product}")
                    create_notification(st.session_state.user, "âœ… ØªÙ… Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†Ùƒ Ø¨Ù†Ø¬Ø§Ø­!", "success")
                    st.success("âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­!")
                    st.balloons()
            else:
                st.error("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©")

# ==========================================
# 10. ØµÙØ­Ø© Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø°ÙƒÙŠ
# ==========================================
def show_market(conn):
    conn.execute("INSERT INTO page_views(page,view_time) VALUES('market',datetime('now'))")
    conn.commit()
    
    # Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ±
    render_filters_ui()
    
    # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
    query = """
        SELECT a.*, IFNULL(AVG(r.rating),0) as avg_r, COUNT(r.rating) as count_r,
               (SELECT COUNT(*) FROM favorites f WHERE f.ad_id = a.id) as fav_count
        FROM ads a 
        LEFT JOIN ratings r ON a.id = r.ad_id 
        WHERE a.status='active'
    """
    params = []
    
    # ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±
    filters = st.session_state.filters
    
    if filters["wilaya"] != "Ø§Ù„ÙƒÙ„":
        query += " AND a.wilaya LIKE ?"
        params.append(f"%{filters['wilaya']}%")
    
    if filters["category"] != "Ø§Ù„ÙƒÙ„":
        query += " AND a.category = ?"
        params.append(filters["category"])
    
    query += " AND a.price BETWEEN ? AND ?"
    params.extend([filters["min_price"], filters["max_price"]])
    
    if filters["featured_only"]:
        query += " AND a.featured = 1"
    
    if filters["date_range"] == "Ø§Ù„ÙŠÙˆÙ…":
        query += " AND date(a.date) = date('now')"
    elif filters["date_range"] == "Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹":
        query += " AND a.date > datetime('now', '-7 days')"
    elif filters["date_range"] == "Ø§Ù„Ø´Ù‡Ø±":
        query += " AND a.date > datetime('now', '-30 days')"
    
    query += " GROUP BY a.id"
    
    # Ø§Ù„ØªØ±ØªÙŠØ¨
    if filters["sort_by"] == "Ø§Ù„Ø£Ø­Ø¯Ø«":
        query += " ORDER BY a.id DESC"
    elif filters["sort_by"] == "Ø§Ù„Ø£Ù‚Ø¯Ù…":
        query += " ORDER BY a.id ASC"
    elif filters["sort_by"] == "Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±Ø§Ù‹":
        query += " ORDER BY a.price DESC"
    elif filters["sort_by"] == "Ø§Ù„Ø£Ù‚Ù„ Ø³Ø¹Ø±Ø§Ù‹":
        query += " ORDER BY a.price ASC"
    elif filters["sort_by"] == "Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø´Ø§Ù‡Ø¯Ø©":
        query += " ORDER BY a.views DESC"
    
    ads = conn.execute(query, params).fetchall()
    
    df = pd.DataFrame(ads, columns=["id","product","price","phone","wilaya","description","date","owner","views","featured","category","images","status","avg_r","count_r","fav_count"])
    
    # Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ
    if filters["search_query"]:
        search = filters["search_query"].lower()
        df = df[df["product"].str.contains(search, case=False, na=False) | 
                df["description"].str.contains(search, case=False, na=False)]
    
    st.markdown(f"### ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬: {len(df)} Ø¥Ø¹Ù„Ø§Ù†")
    
    if len(df) > 0:
        items_per_page = 5
        total_pages = max(1, (len(df) + items_per_page - 1) // items_per_page)
        
        page = st.number_input("Ø§Ù„ØµÙØ­Ø©", min_value=1, max_value=total_pages, value=1)
        start_idx = (page - 1) * items_per_page
        end_idx = min(start_idx + items_per_page, len(df))
        
        for _, ad in df.iloc[start_idx:end_idx].iterrows():
            conn.execute("UPDATE ads SET views = views + 1 WHERE id=?", (ad['id'],))
            conn.commit()
            
            with st.container():
                st.markdown(f"""
                    <div class="ad-card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <h2 style="margin:0; color:#006633;">{ad['product']} 
                                {f'<span class="badge-premium">â­ Ù…Ù…ÙŠØ²</span>' if ad['featured'] else ''}</h2>
                                <p>{ad['description'][:150]}...</p>
                                <p>ğŸ“ {ad['wilaya']} | ğŸ’° {ad['price']:,} Ø¯Ø¬ | ğŸ‘ï¸ {ad['views']}</p>
                                <p>â­ {ad['avg_r']:.1f} | ğŸ’– {ad['fav_count']}</p>
                            </div>
                        </div>
                    </div>
                """, unsafe_allow_html=True)
                
                col_a, col_b = st.columns(2)
                with col_a:
                    if st.button("â¤ï¸ Ø­ÙØ¸", key=f"fav_{ad['id']}"):
                        toggle_favorite(st.session_state.user, ad['id'])
                        st.rerun()
                with col_b:
                    if st.button("ğŸ’¬ Ù…Ø±Ø§Ø³Ù„Ø©", key=f"msg_{ad['id']}"):
                        st.session_state[f"chat_with_{ad['owner']}"] = ad['id']
                        st.rerun()
    else:
        st.info("ğŸ˜• Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª")

# ==========================================
# 11. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
# ==========================================
if "user" not in st.session_state:
    st.session_state.user = None
if "role" not in st.session_state:
    st.session_state.role = "user"

def auth_page():
    st.markdown('<div class="main-header"><h1 style="color:#d21034; background:white; display:inline-block; padding:15px 50px; border-radius:20px; font-weight:900;">ğŸ‡©ğŸ‡¿ RASSIM DZ TITANIUM</h1></div>', unsafe_allow_html=True)
    
    t1, t2 = st.tabs(["ğŸ”’ Ø¯Ø®ÙˆÙ„", "âœ¨ ØªØ³Ø¬ÙŠÙ„"])
    conn = get_connection()
    
    with t1:
        u = st.text_input("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
        p = st.text_input("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±", type="password")
        if st.button("Ø¯Ø®ÙˆÙ„"):
            data = conn.execute("SELECT password, salt, banned, role FROM users WHERE username=?", (u,)).fetchone()
            if data and data[0] == hash_password(p, data[1]) and not data[2]:
                st.session_state.user = u
                st.session_state.role = data[3]
                conn.execute("UPDATE users SET last_login=datetime('now') WHERE username=?", (u,))
                conn.commit()
                st.rerun()
            else:
                st.error("âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©")
    
    with t2:
        nu = st.text_input("Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯")
        np = st.text_input("ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±", type="password")
        email = st.text_input("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ")
        
        if st.button("ØªØ³Ø¬ÙŠÙ„"):
            try:
                salt = secrets.token_hex(16)
                conn.execute("INSERT INTO users(username,password,salt,email) VALUES(?,?,?,?)",
                           (nu, hash_password(np, salt), salt, email))
                conn.commit()
                st.success("âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„!")
            except:
                st.error("âš ï¸ Ø§Ù„Ø§Ø³Ù… Ù…Ø­Ø¬ÙˆØ²")

# ==========================================
# 12. Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
# ==========================================
def dashboard():
    track_visitor()
    track_session()
    conn = get_connection()
    
    with st.sidebar:
        st.markdown(f"### ğŸ–ï¸ {st.session_state.user}")
        
        unread = get_unread_notif(st.session_state.user) + get_unread_messages(st.session_state.user)
        notif_badge = f" ğŸ”” ({unread})" if unread > 0 else " ğŸ””"
        
        online = conn.execute("SELECT COUNT(DISTINCT ip) FROM visitors WHERE last_seen > datetime('now','-5 minutes')").fetchone()[0]
        st.info(f"ğŸŸ¢ Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ù†Ø´Ø·ÙˆÙ†: {online}")
        
        menu = ["ğŸ” Ø§Ù„Ø³ÙˆÙ‚", "ğŸ“¢ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†", "â­ Ø§Ù„Ù…ÙØ¶Ù„Ø©", "ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„", notif_badge, "ğŸ¤– Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "ğŸ“Š ØªØ­Ù„ÙŠÙ„Ø§Øª"]
        
        if st.session_state.role == "admin":
            menu.append("ğŸ›¡ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©")
        
        choice = st.radio("Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©", menu)
        
        if st.button("ğŸšª Ø®Ø±ÙˆØ¬"):
            st.session_state.user = None
            st.rerun()
        
        with st.expander("ğŸ¯ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©"):
            st.json(st.session_state.filters)
    
    if choice == "ğŸ” Ø§Ù„Ø³ÙˆÙ‚":
        show_market(conn)
    elif choice == "ğŸ“¢ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†":
        post_ad(conn)
    elif choice == "ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„":
        show_chat_system(conn)
    elif choice == notif_badge:
        st.info("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª")
    elif choice == "ğŸ¤– Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯":
        show_ai_assistant()
    elif choice == "ğŸ“Š ØªØ­Ù„ÙŠÙ„Ø§Øª":
        st.header("ğŸ“Š ØªØ­Ù„ÙŠÙ„Ø§Øª")
        st.bar_chart(conn.execute("SELECT category, COUNT(*) FROM ads GROUP BY category").fetchall())
    elif choice == "ğŸ›¡ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©" and st.session_state.role == "admin":
        st.header("ğŸ›¡ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…")
        users = conn.execute("SELECT username, email, role, banned FROM users").fetchall()
        st.dataframe(pd.DataFrame(users, columns=["Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", "Ø§Ù„Ø¨Ø±ÙŠØ¯", "Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©", "Ù…Ø­Ø¸ÙˆØ±"]))

# ==========================================
# 13. Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
# ==========================================
if st.session_state.user:
    dashboard()
else:
    auth_page()
ğŸ“‹ Ø®Ø·ÙˆØ§Øª

Continuer


